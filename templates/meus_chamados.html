{% extends "layout.html" %}

{% block title %}Meus Chamados{% endblock %}

{% block content %}
<div class="container mt-4">

    {% if user.is_admin %}
    <div class="row">
        <div class="col-lg-6">
            <h3>Chamados Atribuídos a Mim</h3>
             {% if chamados_atribuidos %}
                {% for chamado in chamados_atribuidos %}
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between">
                            <strong>Chamado #{{ chamado.id }} - {{ chamado.municipio }}</strong>
                            <span class="badge bg-info">{{ chamado.status_nome }}</span>
                        </div>
                        <div class="card-body">
                           <p><strong>Data:</strong> {{ chamado.timestamp.split('.')[0] }}</p>
                           <p><strong>Solicitante:</strong> {{ chamado.solicitante_email }}</p>
                           <p><strong>IMEI:</strong> {{ chamado.smartphone_imei }}</p>
                           <p><strong>Problema:</strong> {{ chamado.tipo_problema_nome }}</p>
                           <p><strong>Observações:</strong> {{ chamado.observacoes }}</p>
                           <form action="{{ url_for('update_chamado', chamado_id=chamado.id) }}" method="post">
                               <div class="mb-3">
                                   <label for="status-{{ chamado.id }}" class="form-label">Alterar Status:</label>
                                   <select name="status" id="status-{{ chamado.id }}" class="form-select">
                                        {% for status in status_options %}
                                            <option value="{{ status.id }}" {% if status.id == chamado.status_id %}selected{% endif %}>{{ status.nome }}</option>
                                        {% endfor %}
                                   </select>
                               </div>
                               <div class="mb-3">
                                   <label for="solucao-{{ chamado.id }}" class="form-label">Solução Aplicada:</label>
                                   <textarea name="solucao" id="solucao-{{ chamado.id }}" class="form-control" rows="2">{{ chamado.solucao or '' }}</textarea>
                               </div>
                               <button type="submit" class="btn btn-success btn-sm">Atualizar</button>
                           </form>
                        </div>
                    </div>
                {% endfor %}
             {% else %}
                 <div class="alert alert-secondary">Nenhum chamado atribuído a você no momento.</div>
             {% endif %}
        </div>

        <div class="col-lg-6">
            <h3>Chamados Abertos (Geral)</h3>
            {% if chamados_gerais %}
                {% for chamado in chamados_gerais %}
                    {% set card_class = 'bg-light text-muted' if chamado.status_nome == 'Finalizado' else 'border-2 border-' + chamado.cor_borda %}

                    <div class="card mb-3 {{ card_class }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                             <strong>Chamado #{{ chamado.id }} - {{ chamado.municipio }}</strong>
                             <span class="badge fs-6 {% if chamado.status_nome == 'Finalizado' %}bg-secondary{% else %}bg-{{ chamado.cor_borda }}{% endif %}">
                                 {{ chamado.status_nome }}
                             </span>
                        </div>
                        <div class="card-body">
                             <p><strong>Data de Abertura:</strong> {{ chamado.timestamp.split('.')[0] }}</p>
                             <p><strong>Solicitante:</strong> {{ chamado.solicitante_email }}</p>
                             <p><strong>IMEI do Smartphone:</strong> {{ chamado.smartphone_imei }}</p>
                             <p><strong>Tipo de Problema:</strong> {{ chamado.tipo_problema_nome }}</p>
                             <p class="mt-2"><strong>Detalhamento do problema/solicitação:</strong><br>{{ chamado.observacoes }}</p>
                        </div>
                        <div class="card-footer text-end">
                            {% if chamado.status_nome == 'Aberto' %}
                                <form action="{{ url_for('capturar_chamado', chamado_id=chamado.id) }}" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fas fa-hand-paper me-1"></i>Capturar Chamado
                                    </button>
                                </form>
                            {% else %}
                                <small class="text-muted">Este chamado não permite mais ações.</small>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-success">Não há chamados gerais em aberto.</div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <h3>Meus Chamados Registrados</h3>
        {% if chamados %}
            {% for chamado in chamados %}
                <div class="card mb-3">
                     <div class="card-header d-flex justify-content-between">
                         <strong>Chamado #{{ chamado.id }}</strong>
                         <span class="badge bg-primary">{{ chamado.status_nome }}</span>
                     </div>
                     <div class="card-body">
                        </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">Você ainda não abriu nenhum chamado.</div>
        {% endif %}
    {% endif %}

</div>
{% endblock %}