{% extends "layout.html" %}

{% block title %}Meus Chamados{% endblock %}

{% block content %}
<div class="header">
    <h1>Meus Chamados Registrados</h1>
</div>

<div class="chamados-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="get" class="filter-form">
        <label for="status">Filtrar por Status:</label>
        <select name="status" id="status" onchange="this.form.submit()">
            <option value="">-- Todos os Status --</option>
            {% for option in status_options %}
                <option value="{{ option.id }}" {% if option.id == status_filter_id %}selected{% endif %}>
                    {{ option.nome }}
                </option>
            {% endfor %}
        </select>
        <a href="{{ url_for('meus_chamados') }}" class="button-link" style="background-color: #6c757d;">Limpar</a>
    </form>

    {% if chamados %}
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Data</th>
                    <th>Município</th>
                    <th>Problema</th>
                    <th>Equipamento (IMEI)</th>
                    <th>Status</th>
                    <th class="col-solucao">Solução</th>
                    <th class="col-foto">Foto</th>
                    <th class="col-acao">Ação</th>
                </tr>
            </thead>
            <tbody>
                {% for chamado in chamados %}
                <tr>
                  <form action="{{ url_for('update_chamado', chamado_id=chamado.id) }}" method="post">
                    <td>#{{ chamado.id }}</td>
                    <td>{{ chamado.timestamp.split(' ')[0].split('-') | reverse | join('/') }}</td>
                    <td>{{ chamado.municipio }}</td>
                    <td>{{ chamado.tipo_problema_nome }}</td>
                    <td>{{ chamado.smartphone_imei }}</td>
                    <td>
                        <select name="status">
                            {% for option in status_options %}
                                <option value="{{ option.id }}" {% if option.id == chamado.status_id %}selected{% endif %}>
                                    {{ option.nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="col-solucao">
                        <textarea name="solucao" rows="3" placeholder="Digite a solução aqui...">{{ chamado.solucao or '' }}</textarea>
                    </td>
                    <td class="col-foto">
                        {% if chamado.foto %}
                            <a href="{{ url_for('display_image', filename=chamado.foto) }}" target="_blank">
                                <img src="{{ url_for('display_image', filename=chamado.foto) }}" alt="Foto do chamado" width="100">
                            </a>
                        {% else %}
                            Sem anexo
                        {% endif %}
                    </td>
                    <td class="col-acao">
                        <button type="submit">Salvar</button>
                    </td>
                  </form>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="text-align: center; margin-top: 1em;">Nenhum chamado encontrado com os filtros selecionados.</p>
    {% endif %}
</div>

<div style="text-align: center; margin-top: 2em;">
    <a href="{{ url_for('index') }}" class="back-button">Abrir um Novo Chamado</a>
</div>
{% endblock %}